#+title: Danszek's doom-emacs config

* Table of content :toc:
- [[#font-theme-and-visuals][font, theme and visuals]]
  - [[#animations-cursor-and-scroll-settings-for-a-fresher-ui][animations, cursor and scroll settings for a fresher ui]]
- [[#org-mode-configs][org mode configs]]
  - [[#font-configs][font configs]]
  - [[#emphasis-markers][emphasis markers]]
  - [[#inline-images][inline images]]
  - [[#links][links]]
  - [[#org-modern-configs][org-modern configs]]
- [[#nixos-specific-config-to-rebuild-and-stuff][NixOS specific config to rebuild and stuff]]
- [[#misc][Misc]]
  - [[#envrc][envrc]]
  - [[#indentation-configs][indentation configs]]
  - [[#garbage-colletion-tuning][garbage colletion tuning]]
  - [[#modeline-performance-optimization][modeline performance optimization]]
  - [[#lsp-performance-optimization][lsp performance optimization]]
  - [[#which-key-configuration][which-key configuration]]
  - [[#shell-config][shell config]]
- [[#programmiersprachen][Programmiersprachen]]
  - [[#groovy][Groovy]]

* font, theme and visuals

 Doom exposes five (optional) variables for controlling fonts in Doom:

   - `doom-font' -- the primary font to use
   - `doom-variable-pitch-font' -- a non-monospace font (where applicable)
   - `doom-big-font' -- used for `doom-big-font-mode'; use this for
     presentations or streaming.
   - `doom-symbol-font' -- for symbols
   - `doom-serif-font' -- for the `fixed-pitch-serif' face

 See 'C-h v doom-font' for documentation and more examples of what they
 accept. For example:

(setq doom-font (font-spec :family "Fira Code" :size 12 :weight 'semi-light)
      doom-variable-pitch-font (font-spec :family "Fira Sans" :size 13))

 If you or Emacs can't find your font, use 'M-x describe-font' to look them
 up, `M-x eval-region' to execute elisp code, and 'M-x doom/reload-font' to
 refresh your font settings. If Emacs still can't find your font, it likely
 wasn't installed correctly. Font issues are rarely Doom issues!

 The font needs to be installed on your system: https://typeof.net/Iosevka/

#+begin_src emacs-lisp
(setq doom-font (font-spec :size 24 :family "Iosevka"))
(setq doom-theme 'ef-day)
#+end_src


This determines the style of line numbers in effect.
Possible values are:

| value    | effect                          |
|----------+---------------------------------|
| nil      | don't show any line numbers     |
| t        | (true) show normal line numbers |
| relative | show relative line numbers      |

Relative line numbers are more performant and more useful for vim motions:
#+begin_src emacs-lisp
(setq display-line-numbers-type 'relative)
#+end_src

** animations, cursor and scroll settings for a fresher ui

emacs built-in version of smooth-scroll:
DEAKTIVIERT - verursacht massive Performance-Probleme auf Wayland/PGTK (15 Hz statt 60 Hz)
#+begin_src emacs-lisp
;; (pixel-scroll-precision-mode 1)  ; DISABLED: Causes severe lag on Wayland
#+end_src

pulse effects for various actions:
#+begin_src emacs-lisp
(setq pulse-delay 0.05)
(setq pulse-iterations 15)
#+end_src

* org mode configs

#+begin_src emacs-lisp
(setq org-directory "~/org/")
#+end_src

** font configs

This will customize the org mode headers to be slightly bigger than normal text.
#+begin_src emacs-lisp
(setq org-fontify-whole-heading-line t
    org-fontify-done-headline t
    org-fontify-quote-and-verse-blocks t)

(custom-set-faces!
'(org-level-1 :inherit outline-1 :height 1.2 :weight bold)
'(org-level-2 :inherit outline-2 :height 1.1 :weight bold)
'(org-level-3 :inherit outline-3 :height 1.05 :weight semi-bold)
'(org-level-4 :inherit outline-4 :height 1.01 :weight semi-bold)
'(org-document-title :height 1.4 :weight bold))

#+end_src


** emphasis markers
#+begin_src emacs-lisp
(setq org-hide-emphasis-markers t
    org-pretty-entities t)
#+end_src

** inline images
#+begin_src emacs-lisp
(setq org-startup-with-inline-images t
    org-image-actual-width '(500))
#+end_src

** links
#+begin_src emacs-lisp
(setq org-link-descriptive t)
#+end_src

** org-modern configs
#+begin_src emacs-lisp
(setq org-modern-table-horizontal t)
#+end_src

* NixOS specific config to rebuild and stuff

#+begin_src emacs-lisp
(after! compile
  ;; NixOS Flake Konfiguration
  (defvar my/nixos-flake-path "/home/david/nixos-config"
    "Path to your NixOS flake directory")

  (defvar my/nixos-flake-host "desktop"
    "NixOS flake host configuration name")

  ;; Hauptfunktion für NixOS rebuild - MIT interaktivem sudo!
  (defun my/nixos-rebuild (&optional arg)
    "Rebuild NixOS with flake configuration in vterm (interactive sudo).
With prefix arg (C-u), prompt for different options."
    (interactive "P")
    (let* ((action (if arg
                       (completing-read "Action: "
                                      '("switch" "boot" "test" "build" "dry-build"))
                     "switch"))
           (flake-ref (format "%s#%s" my/nixos-flake-path my/nixos-flake-host))
           (cmd (format "sudo nixos-rebuild %s --flake %s" action flake-ref))
           (default-directory my/nixos-flake-path)
           (buffer-name "*nixos-rebuild*"))
      ;; Nutze vterm für interaktive sudo-Eingabe
      (if (get-buffer buffer-name)
          (switch-to-buffer-other-window buffer-name)
        (let ((vterm-buffer (get-buffer-create buffer-name)))
          (with-current-buffer vterm-buffer
            (vterm-mode)
            (setq-local default-directory my/nixos-flake-path))
          (display-buffer vterm-buffer)))
      (with-current-buffer buffer-name
        (vterm-send-string cmd)
        (vterm-send-return))))

  ;; Schneller test build (ohne sudo, mit compile-mode)
  (defun my/nixos-build ()
    "Build NixOS configuration without switching (no sudo needed)"
    (interactive)
    (let ((flake-ref (format "%s#%s" my/nixos-flake-path my/nixos-flake-host))
          (default-directory my/nixos-flake-path))
      (compile (format "nixos-rebuild build --flake %s" flake-ref))))

  ;; Flake update
  (defun my/nixos-flake-update ()
    "Update flake.lock"
    (interactive)
    (let ((default-directory my/nixos-flake-path))
      (compile "nix flake update")))

  ;; Flake check (schnelle Syntax-Prüfung)
  (defun my/nixos-flake-check ()
    "Check flake for errors"
    (interactive)
    (let ((default-directory my/nixos-flake-path))
      (compile "nix flake check")))

  ;; Auto-detect und setze compile command für NixOS files
  (defun my/set-nixos-compile-command ()
    "Set compile command for NixOS configuration files"
    (when (and buffer-file-name
               (string-match-p (regexp-quote my/nixos-flake-path) buffer-file-name))
      (setq-local compile-command
                  (format "sudo nixos-rebuild switch --flake %s#%s"
                          my/nixos-flake-path
                          my/nixos-flake-host))))

  (add-hook 'nix-mode-hook #'my/set-nixos-compile-command)

  ;; Keybindings - SPC d für "deploy" / NixOS
  (map! :leader
        (:prefix ("d" . "deploy/NixOS")
         :desc "Rebuild switch" "r" #'my/nixos-rebuild
         :desc "Build only" "b" #'my/nixos-build
         :desc "Flake update" "u" #'my/nixos-flake-update
         :desc "Flake check" "c" #'my/nixos-flake-check))

  ;; Spezifische Keybindings in nix-mode
  (map! :map nix-mode-map
        :localleader
        :desc "Rebuild NixOS" "r" #'my/nixos-rebuild
        :desc "Build only" "b" #'my/nixos-build
        :desc "Flake check" "c" #'my/nixos-flake-check
        :desc "Flake update" "u" #'my/nixos-flake-update))
#+end_src

* Misc

** envrc
#+begin_src emacs-lisp
(use-package! envrc
  :config
(envrc-global-mode))
#+end_src

** indentation configs
#+begin_src emacs-lisp
(setq-default tab-width 4)
(setq-default indent-tabs-mode nil)
#+end_src

** garbage colletion tuning

  #+begin_src emacs-lisp
  ;; Increase GC threshold during startup
  (setq gc-cons-threshold most-positive-fixnum)

  ;; Reset it after startup, but keep it higher than default
  (add-hook 'emacs-startup-hook
    (lambda ()
      (setq gc-cons-threshold (* 100 1024 1024)))) ;; 100MB

  ;; GC when idle (15s interval to avoid micro-stutters)
  (run-with-idle-timer 15 t #'garbage-collect)
  #+end_src

** modeline performance optimization

The modeline updates constantly during scrolling (line, column, %), which is a known performance bottleneck.
Let's optimize it by simplifying and reducing update frequency:

#+begin_src emacs-lisp
;; Simplify doom-modeline for better performance
(after! doom-modeline
  (setq doom-modeline-buffer-file-name-style 'relative-to-project)
  (setq doom-modeline-enable-word-count nil)
  (setq doom-modeline-checker-simple-format t)
  (setq doom-modeline-vcs-max-length 20)
  (setq doom-modeline-buffer-modification-icon nil))
#+end_src

** lsp performance optimization

emacs-lsp-booster is a wrapper that converts JSON messages from LSP servers
directly to elisp bytecode at high speed. This provides massive performance improvements
for LSP (Language Server Protocol) functionality.

#+begin_src emacs-lisp
(after! lsp-mode
  ;; Use emacs-lsp-booster for performance
  (defun lsp-booster--advice-json-parse (old-fn &rest args)
    "Try to parse with emacs-lsp-booster, fallback to original parser."
    (or
     (when (executable-find "emacs-lsp-booster")
       (condition-case nil
           (apply old-fn args)
         (error nil)))
     (apply old-fn args)))

  (advice-add (if (progn (require 'json)
                         (fboundp 'json-parse-buffer))
                  'json-parse-buffer
                'json-read)
              :around
              #'lsp-booster--advice-json-parse)

  ;; Additional LSP performance settings
  (setq lsp-use-plists t)              ; Use plists for performance
  (setq lsp-log-io nil)                 ; Disable logging for speed
  (setq lsp-idle-delay 0.5)             ; Faster responses
  (setq lsp-enable-file-watchers nil))  ; Disable file watchers in large projects
#+end_src

** which-key configuration

which-key shows available keybindings after you start typing a command.
Let's make it appear faster for better responsiveness:

#+begin_src emacs-lisp
(after! which-key
  (setq which-key-idle-delay 0.3))  ; Show keybindings after 0.3s instead of 1.0s
#+end_src

** shell config
Since my user's default shell is nushell, we explicitly need to set the shell for emacs to use.
#+begin_src emacs-lisp
(setq explicit-shell-file-name "/run/current-system/sw/bin/bash")
(setq shell-file-name "bash")
#+end_src

* Programmiersprachen

** Groovy
Konfiguration für Groovy mit LSP-Support über lsp-mode. Dies ermöglicht Autocomplete, Jump-to-Definition, Dokumentation und weitere IDE-Features für Groovy-Dateien.

Voraussetzung: Der Groovy Language Server muss installiert sein

#+begin_src emacs-lisp
;; Groovy LSP configuration
(use-package! lsp-groovy
  :after lsp-mode
  :config
  ;; IO Logging aktivieren für Debugging
  ;; (setq lsp-log-io t)

  ;; Classpath für Groovy LSP
  ;; Diese custom LSP-Version unterstützt /** für rekursive Suche
  (setq lsp-groovy-classpath [".m2/**" "/home/david/.m2/**"]))

(add-hook 'groovy-mode-hook #'lsp-deferred)
#+end_src
